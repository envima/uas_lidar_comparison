---
title: "UAS Pointclouds vs. Lidar Pointclouds for structual analysis of forests"
output: github_document
bibliography: literature.bib
---

```{r setup, include = FALSE}
source("../scripts/000_setup.R")
library(ggpubr)


ggHexCor = function(df, metric){
  ggplot(df, aes_(x = as.name(paste0("lidar_", metric)),y = as.name(paste0("sparsecloud_", metric))))+
      geom_hex()+
      scale_fill_gradientn(name = "Count",colors = viridis(25))+
      geom_abline(slope = 1, intercept = 0, color = "red", lwd = 1)+
      coord_equal()+
      theme(panel.background = element_blank())
}

```

# Introduction

Lidar indices are commonly used for forest structural analysis... Photogrammetrically received pointclouds from UAS might be a cost-efficient alternative...
UAS pointclouds do not have return values which many Lidar indices depend on
The quality and viability of UAS pointclouds have to be assessed in terms of comparability to Lidar pointclouds (since Lidar structural analysis is the standard in many studies)


# Epic 1: Similarities between Lidar and UAS pointclouds

Since photogrammetically received pointclouds only capture the surface and do not penetrate the forest canopy like Lidar pointclouds, different phenological stages should capture different vertical layers of the forest canopy. Therefore, the photogrammetrically received pointcloud should represent and correlate with different parts of the Lidar pointcloud. E.g. a flight without leafs in winter or early spring should correlate well with the last returns of a lidar pointcloud (or a leaf-off lidar campaign) and therefore should be suitable for creating elevation models or the detection of tree stems and branches.

Further, a UAS flight at times with a fully developed canopy leads to pointclouds where it is very unlikely to capture ground points. These pointclouds should be comparable to first returns of a lidar pointcloud. E.g. it was previously shown, that UAS pointclouds are very promising for the estimation of tree heights and canopy cover.

__Hypothesis 1:__ Photogrammetrically received pointclouds from different phenological stages in a deciduous forest correlate with different parts of a LiDAR derived pointcloud.

This relationship will be shown by comparing the vertical distributions of both pointclouds in a regular grid. Further, the Lidar data will be filtered to different return counts in order to check, which part of the lidar data is represented.

# Epic 2: Multitemporal UAS pointclouds compared to Lidar pointclouds

If the positional accuracy of the individual photogrammetric pointclouds is high enough (previously shown in Ludwig et al 2020), it is a resonable assumption to combine pointclouds from different phenological stages in order to get a full 3D model of the forest. The positional accuracy can be validated with tree positions and stem axis surveyed with a totalstation __(How?)__.

__Hypothesis 2:__ Mutlitemporal photogrammetrically received pointclouds can substitude Lidar derived pointclouds for forest structural analysis.

This relation will be shown by comparing commonly used structural indices like the `penetration rate` or the estimation of `biomass` from both pointcloud types. Further, the structural data will be validated by field work around at 15 plots where the vertical structure of the forest was assessed.

## Quick and dirty approach

Comparison of single time stage UAS to Lidar (just to prove the point that a single flight does is not sufficient)

```{r, warning=FALSE}
lidar2018 = readLAS("../data/lidar/lidar2018_halfmoon_20p.las")
sparsecloud = readLAS("../data/sparseclouds/2020_10_13_sparsecloud.las")


source("../scripts/001_pointcloud_height_metrics.R")

sparsecloud_z_metrics = grid_metrics(sparsecloud, func = ~metrics(Z), res = 5)
lidar_z_metrics = grid_metrics(lidar2018, func ~metrics(Z), res = 5)


plot(lidar_z_metrics)

plot(sparsecloud_z_metrics)



z_dif = lidar_z_metrics - sparsecloud_z_metrics
plot(z_dif)


```

# September and November vs. LiDAR

## Minimum point height - Indicator for ground points

```{r, fig.cap="Minimum height of each 5x5m pixel; September has more leafs - Overestimation"}
september = read.csv("../data/z_metrics_tables/2020_09_15_sparsecloud.csv")
november = read.csv("../data/z_metrics_tables/2020_11_06_sparsecloud.csv")

ggarrange(plotlist = list(
  ggHexCor(september, "z_min"),
  ggHexCor(november, "z_min")
  
),nrow = 1, labels = c("2020-09-15", "2020-11-06"), legend = "bottom")


```

Minimum height of each 5x5m pixel; September has more leafs - Overestimation

## Maximum Point height - Indicator for canopy

```{r, fig.cap="Maximum height of each 5x5m pixel; November has less leafs - underestimation"}
september = read.csv("../data/z_metrics_tables/2020_09_15_sparsecloud.csv")
november = read.csv("../data/z_metrics_tables/2020_11_06_sparsecloud.csv")

ggarrange(plotlist = list(
  ggHexCor(september, "z_max"),
  ggHexCor(november, "z_max")
  
),nrow = 1, labels = c("2020-09-15", "2020-11-06"), legend = "bottom")


```

Maximum height of each 5x5m pixel; November has less leafs - underestimation






## Processing protocol

- crop lidar data to halfmoon
- had to throw away the confiers because they were cut between the lidar flight and the UAS flights
- homogenize point density of Lidar data to 20 points per squaremeter



